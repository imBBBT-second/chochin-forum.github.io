<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>초친 포럼 (맵 팩)</title>

    <style>
      /* --- 기본 설정 --- */
      html,
      body {
        min-height: 100vh;
        margin: 0;
        background: #323232;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        color: white;
      }
      * {
        box-sizing: border-box;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      /* 폰트 설정 */
      @font-face {
        font-family: Paperlogy1;
        src: url('font - paperlogy/Paperlogy-1.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy2;
        src: url('font - paperlogy/Paperlogy-2.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy3;
        src: url('font - paperlogy/Paperlogy-3.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy4;
        src: url('font - paperlogy/Paperlogy-4.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy5;
        src: url('font - paperlogy/Paperlogy-5.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy6;
        src: url('font - paperlogy/Paperlogy-6.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy7;
        src: url('font - paperlogy/Paperlogy-7.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy8;
        src: url('font - paperlogy/Paperlogy-8.ttf');
        font-display: swap;
      }
      @font-face {
        font-family: Paperlogy9;
        src: url('font - paperlogy/Paperlogy-9.ttf');
        font-display: swap;
      }

      /* --- 헤더 영역 --- */
      .header-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5vw;
        padding: 2vh 0;
        flex-wrap: wrap;
      }
      .header-btn-wrapper {
        width: min(400px, 90vw);
        display: flex;
        justify-content: center;
      }
      .header-btn {
        background-color: #323232;
        color: white;
        font-size: clamp(1.5rem, 4vw, 3rem);
        cursor: pointer;
        padding: 1.5vh 0;
        border: none;
        border-radius: 10px;
        width: 100%;
        transition:
          background-color 0.25s ease,
          color 0.25s ease;
        font-family: Paperlogy5;
      }
      .header-btn:hover,
      .header-btn.active {
        background-color: #fff;
        color: #323232;
      }
      .divider {
        border: 2px solid white;
        width: 100%;
        height: 0;
        margin: 6px 0;
      }
      .hamburger {
        display: none;
        font-size: 2.5rem;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px;
      }
      .header-container.open .header-btn-wrapper {
        display: flex;
      }

      /* --- 메인 컨테이너 --- */
      .main-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        align-items: stretch;
        min-height: 800px;
      }

      .container,
      .detail-panel {
        background: #404040;
        border-radius: 10px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .container {
        flex: 1;
        min-width: 0;
      }
      .detail-panel {
        flex: 2;
        background: #505050;
        overflow-y: auto;
        min-width: 0;
      }
      .detail-panel.clears-panel {
        flex: 1;
        background: #404040;
      }

      .history-panel {
        width: calc(100% - 40px);
        margin: auto auto 40px auto;
        background: #3a3a3a;
        border-radius: 10px;
        padding: 20px;
        min-height: 200px;
      }

      /* --- 리스트 아이템 스타일 --- */
      .item {
        display: flex;
        align-items: center;
        padding: 15px;
        gap: 15px;
        border-bottom: 1px solid #777;
        cursor: pointer;
        transition: 0.2s;
      }
      .item:hover,
      .item.active {
        background-color: #ffffff;
      }
      .item:hover *,
      .item.active * {
        color: #000000 !important;
      }

      /* 맵 팩 전체 클리어 강조 */
      .item.all-cleared {
        background-color: #2e4a2e;
        border-left: 6px solid #4f9;
      }

      .pack-tier {
        font-family: Paperlogy9;
        font-size: 1.8rem;
        min-width: 60px;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }
      .title {
        font-family: Paperlogy7;
        font-size: 1.4rem;
        color: #fff;
      }
      .creator {
        font-family: Paperlogy4;
        font-size: 0.9rem;
        color: #d0d0d0;
      }

      /* --- 상세 정보 패널 --- */
      .detail-header {
        text-align: center;
        margin-bottom: 20px;
      }
      .pack-title {
        font-family: Paperlogy9;
        font-size: 3rem;
        color: #fff;
        margin-bottom: 5px;
      }
      .pack-subtitle {
        font-family: Paperlogy4;
        font-size: 1.1rem;
        color: #aaa;
      }

      .pack-content-box {
        background: #444;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }
      .content-header {
        font-family: Paperlogy6;
        font-size: 1.5rem;
        color: #fff;
        margin-bottom: 15px;
        border-bottom: 2px solid #666;
        padding-bottom: 10px;
      }

      /* 개별 레벨 아이템 스타일 */
      .level-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #3a3a3a;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: 0.2s;
        cursor: pointer;
      }
      .level-item:hover {
        background: #666;
        transform: translateX(5px);
      }

      /* 개별 레벨 클리어 강조 */
      .level-item.cleared {
        background-color: #2e4a2e !important;
      }
      .level-item.cleared .level-name {
        color: #4f9 !important;
      }
      .check-mark {
        color: #4f9;
        margin-left: 8px;
        display: none;
      }
      .level-item.cleared .check-mark {
        display: inline;
      }

      .level-idx {
        font-family: Paperlogy7;
        font-size: 1.2rem;
        color: #aaa;
        width: 40px;
        text-align: center;
      }
      .level-info {
        flex: 1;
      }
      .level-name {
        font-family: Paperlogy6;
        font-size: 1.1rem;
        color: #fff;
      }
      .level-author {
        font-family: Paperlogy4;
        font-size: 0.85rem;
        color: #ccc;
      }

      .level-rank {
        font-family: Paperlogy9;
        font-size: 1.4rem;
        color: #ffdd44;
        margin: 0 15px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
      }

      .clear-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 10px;
        border-bottom: 1px solid #555;
        color: #fff;
        font-family: Paperlogy5;
      }

      #detailHeader {
        text-align: center;
        margin-bottom: 60px;
      }
      #headerTitle {
        font-family: Paperlogy7;
        font-size: 120px;
        color: #fff;
        margin: 20px 0;
      }
      #detailSubtitle {
        color: #aaa;
        font-family: Paperlogy3;
        font-size: 24px;
      }

      /* 계정 선택 버튼 스타일 */
      .auth-container {
        text-align: right;
        padding: 10px 20px;
        background: #222;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 15px;
      }
      .user-status {
        color: #4f9;
        font-family: Paperlogy5;
      }
      .mode-btn {
        background: transparent;
        border: 1.5px solid #fff;
        color: #fff;
        padding: 5px 15px;
        border-radius: 5px;
        font-family: Paperlogy7;
        cursor: pointer;
        transition: 0.2s;
      }
      .mode-btn:hover {
        background: #fff;
        color: #000;
      }

      @media (max-width: 1400px) {
        .main-container {
          flex-direction: column;
        }
        .container,
        .detail-panel,
        .detail-panel.clears-panel {
          width: 100%;
          margin-bottom: 20px;
          height: auto;
          flex: none;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
          gap: 15px;
        }
        .container,
        .detail-panel,
        .detail-panel.clears-panel {
          padding: 15px;
        }
        #headerTitle {
          font-size: 80px;
        }
        .pack-title {
          font-size: 2.2rem;
        }
        .level-item > div:last-child {
          display: none;
        }
        .header-container {
          flex-direction: column;
          gap: 10px;
        }
        .header-btn-wrapper {
          display: none;
        }
        .hamburger {
          display: block;
        }
      }

      /* --- 개발자 패널 --- */
      .dev-panel {
        position: fixed;
        top: 0;
        right: -480px;
        width: 480px;
        height: 100%;
        background: #222;
        color: white;
        transition: 0.3s ease-in-out;
        z-index: 9999;
        padding: 25px;
        overflow-y: auto;
        border-left: 3px solid #444;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
        font-family: 'Paperlogy5', sans-serif;
      }
      .dev-panel.open {
        right: 0;
      }
      #devPanel h2,
      #devPanel h3 {
        font-family: 'Paperlogy9';
        margin-top: 0;
        color: #fff;
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
      }
      #devPanel label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-size: 0.85rem;
        color: #aaa;
        font-family: 'Paperlogy7';
      }
      .dev-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        background: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 5px;
        font-family: 'Paperlogy3';
        font-size: 0.9rem;
        transition: border 0.2s;
      }
      .dev-input:focus {
        outline: none;
        border-color: #4f9;
      }
      textarea.dev-input {
        resize: vertical;
        min-height: 60px;
        font-family: monospace;
      }
      .dev-btn {
        width: 100%;
        padding: 12px;
        background: #444;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        font-family: 'Paperlogy7';
        font-size: 1rem;
        transition: 0.2s;
      }
      .dev-btn:hover {
        background: #666;
        transform: translateY(-2px);
      }
      .dev-btn-save {
        background: #2ecc71 !important;
        color: #000 !important;
      }
      .dev-btn-save:hover {
        background: #27ae60 !important;
      }
      #devContent .item {
        background: #2a2a2a;
        margin-bottom: 5px;
        border-radius: 4px;
        cursor: pointer;
        border-left: 4px solid #555;
        transition: 0.2s;
        padding: 10px;
      }
      #devContent .item:hover {
        background: #3a3a3a;
        border-left-color: #4f9;
        padding-left: 15px !important;
      }
      #devPanel::-webkit-scrollbar {
        width: 8px;
      }
      #devPanel::-webkit-scrollbar-track {
        background: #222;
      }
      #devPanel::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 10px;
      }
      #devPanel::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>

  <body>
    <div class="auth-container">
      <div id="userStatus" class="user-status"></div>
      <button onclick="login()" class="mode-btn">계정 선택</button>
    </div>

    <div class="header-container">
      <button class="hamburger" onclick="toggleMenu()">☰</button
      ><a href="index.html" class="header-btn-wrapper"
        ><button class="header-btn">홈</button></a
      >
      <a href="level.html" class="header-btn-wrapper"
        ><button class="header-btn">레벨</button></a
      >
      <a href="mappack.html" class="header-btn-wrapper">
        <button class="header-btn">맵 팩</button>
      </a>
      <a href="roulette.html" class="header-btn-wrapper">
        <button class="header-btn">룰렛</button>
      </a>
    </div>

    <div class="divider"></div>

    <div id="detailHeader">
      <div id="headerTitle">Map Packs</div>
      <div id="detailSubtitle">
        다양한 테마와 난이도로 묶인 맵 팩에 도전하세요!
      </div>
    </div>

    <div class="main-container">
      <div class="container">
        <input
          id="search"
          placeholder="팩 검색..."
          style="
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #333;
            color: white;
            margin-bottom: 10px;
          "
        />
        <div id="packList" style="overflow-y: auto; flex: 1"></div>
      </div>

      <div class="detail-panel">
        <div id="packDetailContent">
          <div
            style="
              text-align: center;
              margin-top: 50px;
              color: #888;
              font-family: Paperlogy5;
            "
          >
            데이터를 불러오는 중...
          </div>
        </div>
      </div>

      <div class="detail-panel clears-panel">
        <div
          style="
            font-family: Paperlogy9;
            font-size: 2.5rem;
            text-align: center;
            color: white;
            margin-bottom: 20px;
          "
        >
          All Clears
        </div>
        <div id="packClears"></div>
      </div>
    </div>

    <div class="history-panel">
      <div
        style="
          font-family: Paperlogy9;
          font-size: 2rem;
          text-align: center;
          color: white;
          margin-bottom: 10px;
        "
      >
        최근 변경 기록
      </div>
      <div id="historyBox"></div>
    </div>

    <div id="devPanel" class="dev-panel">
      <div class="detail-header" style="margin-top: 20px">
        <div class="detail-title" style="font-size: 2.5rem">개발자 패널</div>
        <div id="devContent" class="dev-content"></div>
      </div>
    </div>

    <script>
      const DEV_PASSWORD = 'tyviva123';
      const TIER_COLORS = {
        'Tier 1': '#00ffff',
        'Tier 2': '#00ff00',
        'Tier 3': '#ffff00',
        'Tier 4': '#ffaa00',
        'Tier 5': '#ff0000',
        'Tier 6': '#ff00ff',
        Unrated: '#888888',
      };

      let packData = [];
      let classicLevelData = [];
      let changeHistory = [];
      let currentUser = localStorage.getItem('currentUser') || null;

      // GitHub 설정 상수
      const GH_OWNER = 'imBBBT';
      const GH_REPO = 'chochin-forum';
      const GH_PATH = 'mappack.json';
      const GH_TOKEN = '';

      let githubConfig = {
        owner: GH_OWNER,
        repo: GH_REPO,
        path: GH_PATH,
        token: GH_TOKEN || localStorage.getItem('gh_token') || '',
      };

      // 데이터 로딩
      Promise.all([
        fetch('mappack.json')
          .then((r) => r.json())
          .catch(() => ({ packs: [], history: [] })),
        fetch('level/classic.json')
          .then((r) => r.json())
          .catch(() => ({ levels: [] })),
      ])
        .then(([packJson, levelJson]) => {
          packData = packJson.packs || [];
          changeHistory = packJson.history || [];
          classicLevelData = levelJson.levels || [];

          if (currentUser)
            document.getElementById('userStatus').innerText =
              ` 접속 계정 : ${currentUser}`;
          initPage();
        })
        .catch((err) => {
          console.error('데이터 로딩 실패:', err);
        });

      function initPage() {
        packData.sort((a, b) => {
          const getTierNum = (str) => {
            const match = (str || '').match(/Tier\s+(\d+)/i);
            return match ? parseInt(match[1]) : 999;
          };
          return getTierNum(a.tier) - getTierNum(b.tier);
        });

        renderList(packData);
        renderHistory();
        if (packData.length > 0) showPackDetail(packData[0]);
      }

      // 클리어 체크 로직
      function checkIfLevelCleared(levelName) {
        if (!currentUser) return false;
        const name = currentUser.toLowerCase();
        const level = classicLevelData.find(
          (l) =>
            l.title.trim().toLowerCase() === levelName.trim().toLowerCase(),
        );

        if (!level) return false;

        const isCleared =
          level.clears &&
          level.clears.some(
            (c) => c.player.toLowerCase() === name && Number(c.percent) === 100,
          );
        const isVerifier =
          level.verifier && level.verifier.toLowerCase() === name;

        return isCleared || isVerifier;
      }

      function getLevelRank(levelName, author) {
        const levelIndex = classicLevelData.findIndex(
          (l) =>
            l.title.trim().toLowerCase() === levelName.trim().toLowerCase() &&
            l.creator.trim().toLowerCase() === author.trim().toLowerCase(),
        );
        return levelIndex !== -1 ? levelIndex + 1 : '???';
      }

      // 맵 팩 리스트 렌더링
      function renderList(data) {
        const list = document.getElementById('packList');
        list.innerHTML = '';
        data.forEach((pack) => {
          // 맵 팩 전체 클리어 여부 확인
          const isPackAllCleared = pack.levels.every((lvl) =>
            checkIfLevelCleared(lvl.name),
          );

          const div = document.createElement('div');
          div.className = `item ${isPackAllCleared ? 'all-cleared' : ''}`;
          const tierColor = TIER_COLORS[pack.tier] || '#ffffff';
          div.innerHTML = `
            <div class="pack-tier" style="color: ${tierColor}">${pack.tier}</div>
            <div>
              <div class="title">${pack.title} ${isPackAllCleared ? '✅' : ''}</div>
            </div>
          `;
          div.onclick = () => showPackDetail(pack, div);
          list.appendChild(div);
        });
      }

      // 상세 페이지 렌더링
      function showPackDetail(pack, el) {
        document
          .querySelectorAll('.item.active')
          .forEach((i) => i.classList.remove('active'));
        if (el) el.classList.add('active');

        const tierColor = TIER_COLORS[pack.tier] || '#ffffff';
        const content = document.getElementById('packDetailContent');

        content.innerHTML = `
          <div class="detail-header">
            <div class="pack-title">${pack.title}</div>
            <div class="pack-subtitle">${pack.description}</div>
            <div style="margin-top:10px;">
              <span style="background:#333; padding:5px 12px; border-radius:15px; border: 1px solid ${tierColor}; color: ${tierColor}; font-weight:bold;">${
                pack.tier
              }</span>
              <span style="background:#444; padding:5px 12px; border-radius:15px; margin-left:5px; color:#ddd;">Levels: ${
                pack.levels.length
              }</span>
            </div>
          </div>

          <div class="pack-content-box">
            <div class="content-header">맵 리스트</div>
            ${pack.levels
              .map((lvl, idx) => {
                const cleared = checkIfLevelCleared(lvl.name);
                const rank = getLevelRank(lvl.name, lvl.author);
                return `
                <div class="level-item ${
                  cleared ? 'cleared' : ''
                }" onclick="goToLevelAuto('${lvl.name}', '${lvl.author}')">
                  <div class="level-idx">${idx + 1}</div>
                  <div class="level-info">
                    <div class="level-name">${
                      lvl.name
                    } <span class="check-mark">✅</span></div>
                    <div class="level-author">by ${lvl.author}</div>
                  </div>
                  <div class="level-rank">#${rank}</div>
                  <div style="color:#888; font-size:0.8rem;">Click to View →</div>
                </div>
              `;
              })
              .join('')}
          </div>
        `;

        const clearBox = document.getElementById('packClears');
        clearBox.innerHTML = '';
        if (pack.clears && pack.clears.length > 0) {
          pack.clears.forEach((c) => {
            const row = document.createElement('div');
            row.className = 'clear-row';
            row.innerHTML = `<span class="clear-user">${c.player}</span><span class="clear-date">${c.date}</span>`;
            clearBox.appendChild(row);
          });
        } else {
          clearBox.innerHTML =
            '<div style="text-align:center; color:#777; margin-top:20px;">클리어 유저가 없습니다.</div>';
        }
      }

      // 계정 선택 (로그인)
      function login() {
        const name = prompt('닉네임을 입력해주세요.');
        if (!name) return;
        currentUser = name;
        localStorage.setItem('currentUser', name);
        document.getElementById('userStatus').innerText = `접속 계정 : ${name}`;
        alert(`${name}님, 환영합니다!`);
        renderList(packData);
        // 현재 선택된 팩 상세 내용 갱신
        const activeTitle = document
          .querySelector('.item.active .title')
          ?.innerText.replace(' ✅', '');
        const currentPack = packData.find((p) => p.title === activeTitle);
        if (currentPack) showPackDetail(currentPack);
      }

      function goToLevelAuto(levelName, author) {
        const target = classicLevelData.find(
          (l) =>
            l.title.trim().toLowerCase() === levelName.trim().toLowerCase() &&
            l.creator.trim().toLowerCase() === author.trim().toLowerCase(),
        );
        if (target && target.id) {
          window.location.href = `level/classic.html?id=${target.id}`;
        } else {
          alert(`'${levelName}' 레벨을 찾을 수 없습니다.`);
        }
      }

      document.getElementById('search').addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        const filtered = packData.filter((p) =>
          p.title.toLowerCase().includes(val),
        );
        renderList(filtered);
      });

      function renderHistory() {
        const box = document.getElementById('historyBox');
        box.innerHTML = changeHistory
          .slice(0, 10)
          .map(
            (h) => `
          <div style="color:#ccc; font-family:Paperlogy3; margin-bottom:5px;">
            <span style="color:#66ccff">[${h.time}]</span> <b>${h.type}</b>: ${h.detail}
          </div>
        `,
          )
          .join('');
      }

      function addHistory(type, title, detail) {
        const now = new Date();
        const timeStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        changeHistory.unshift({
          time: timeStr,
          type,
          detail,
        });
        renderHistory();
      }

      /* ================= 개발자 패널 로직 ================= */
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'e') {
          const panel = document.getElementById('devPanel');
          if (panel.classList.contains('open')) panel.classList.remove('open');
          else if (prompt('개발자 비밀번호') === DEV_PASSWORD) {
            panel.classList.add('open');
            renderDevHome();
          }
        }
      });

      function renderDevHome() {
        document.getElementById('devContent').innerHTML = `
          <button class="dev-btn" onclick="renderPackForm()">새 팩 등록</button>
          <button class="dev-btn" onclick="renderEditList()">팩 수정 / 기록 갱신</button>
          <button class="dev-btn" onclick="renderGitHubConfig()" style="background:#8e44ad;">GitHub 설정</button>
          <button class="dev-btn" onclick="saveToGitHub()" style="background:#2980b9;">GitHub에 저장</button>
          <button class="dev-btn" onclick="exportJson()" style="background:#5cb85c;">JSON 내보내기</button>
        `;
      }

      function renderEditList() {
        let html =
          '<h3>수정할 팩 선택</h3><div style="max-height:300px; overflow-y:auto; background:#333; border-radius:5px;">';
        packData.forEach((pack, idx) => {
          html += `<div class="item" onclick="renderPackForm(${idx})">${pack.title} (${pack.tier})</div>`;
        });
        html +=
          '</div><button class="dev-btn" onclick="renderDevHome()">뒤로가기</button>';
        document.getElementById('devContent').innerHTML = html;
      }

      function renderPackForm(idx = null) {
        const isEdit = idx !== null;
        const pack = isEdit
          ? packData[idx]
          : {
              id: `pack ${packData.length + 1}`,
              title: '',
              tier: 'Tier 1',
              description: '',
              levels: [],
              clears: [],
            };

        const mkInput = (id, ph, val) =>
          `<input id="${id}" class="dev-input" placeholder="${ph}" value="${val || ''}">`;

        let levelsHtml = '';
        (pack.levels || []).forEach((lvl, i) => {
          levelsHtml += `
            <div class="clear-edit-row" style="display:flex; gap:3px; margin-bottom:5px;">
              <input class="dev-input lvl-name" placeholder="레벨 이름" value="${lvl.name}" style="flex:2">
              <input class="dev-input lvl-author" placeholder="제작자" value="${lvl.author}" style="flex:1">
              <button onclick="this.parentElement.remove()" style="background:#e74c3c; border:none; color:white; border-radius:4px; cursor:pointer; width:30px;">X</button>
            </div>`;
        });

        let clearsHtml = '';
        (pack.clears || []).forEach((c, i) => {
          clearsHtml += `
            <div class="clear-edit-row" style="display:flex; gap:3px; margin-bottom:5px;">
              <input class="dev-input cl-p" placeholder="유저" value="${c.player}" style="flex:2">
              <input class="dev-input cl-d" placeholder="날짜" value="${c.date}" style="flex:1">
              <button onclick="this.parentElement.remove()" style="background:#e74c3c; border:none; color:white; border-radius:4px; cursor:pointer; width:30px;">X</button>
            </div>`;
        });

        document.getElementById('devContent').innerHTML = `
          <h3>${isEdit ? '팩 수정' : '새 팩 등록'}</h3>
          <div style="max-height:450px; overflow-y:auto; padding-right:10px;">
            <label>기본 정보</label>
            ${mkInput('p-title', '팩 제목', pack.title)}
            ${mkInput('p-tier', '티어 (예: Tier 1)', pack.tier)}
            <textarea id="p-desc" class="dev-input" placeholder="설명">${pack.description || ''}</textarea>

            <label>레벨 목록</label>
            <div id="p-levels-container">${levelsHtml}</div>
            <button class="dev-btn" onclick="addLevelInputRow()" style="background:#3498db; margin-top:5px;">+ 레벨 추가</button>

            <label>클리어 명단</label>
            <div id="p-clears-container">${clearsHtml}</div>
            <button class="dev-btn" onclick="addClearInputRow()" style="background:#3498db; margin-top:5px;">+ 기록 추가</button>
          </div>
          <button class="dev-btn dev-btn-save" onclick="savePackForm(${idx})">${isEdit ? '수정 완료' : '등록 완료'}</button>
          ${isEdit ? `<button class="dev-btn" onclick="deletePack(${idx})" style="background:#e74c3c;">삭제</button>` : ''}
          <button class="dev-btn" onclick="renderDevHome()">취소</button>
        `;
      }

      function addLevelInputRow() {
        const div = document.createElement('div');
        div.className = 'clear-edit-row';
        div.style = 'display:flex; gap:3px; margin-bottom:5px;';
        div.innerHTML = `
          <input class="dev-input lvl-name" placeholder="레벨 이름" style="flex:2">
          <input class="dev-input lvl-author" placeholder="제작자" style="flex:1">
          <button onclick="this.parentElement.remove()" style="background:#e74c3c; border:none; color:white; border-radius:4px; cursor:pointer; width:30px;">X</button>
        `;
        document.getElementById('p-levels-container').appendChild(div);
      }

      function addClearInputRow() {
        const div = document.createElement('div');
        div.className = 'clear-edit-row';
        div.style = 'display:flex; gap:3px; margin-bottom:5px;';
        div.innerHTML = `
          <input class="dev-input cl-p" placeholder="유저" style="flex:2">
          <input class="dev-input cl-d" placeholder="날짜" style="flex:1">
          <button onclick="this.parentElement.remove()" style="background:#e74c3c; border:none; color:white; border-radius:4px; cursor:pointer; width:30px;">X</button>
        `;
        document.getElementById('p-clears-container').appendChild(div);
      }

      function savePackForm(idx) {
        const isEdit = idx !== null;
        const title = document.getElementById('p-title').value;
        const tier = document.getElementById('p-tier').value;
        const desc = document.getElementById('p-desc').value;

        const levels = [];
        document
          .querySelectorAll('#p-levels-container .clear-edit-row')
          .forEach((row) => {
            const name = row.querySelector('.lvl-name').value.trim();
            const author = row.querySelector('.lvl-author').value.trim();
            if (name) levels.push({ name, author });
          });

        const clears = [];
        document
          .querySelectorAll('#p-clears-container .clear-edit-row')
          .forEach((row) => {
            const player = row.querySelector('.cl-p').value.trim();
            const date = row.querySelector('.cl-d').value.trim();
            if (player) clears.push({ player, date });
          });

        const newPack = {
          id: isEdit ? packData[idx].id : `pack ${packData.length + 1}`,
          title,
          tier,
          description: desc,
          levels,
          clears,
        };

        if (isEdit) {
          packData[idx] = newPack;
          addHistory('팩 수정', title, `${title} 팩 정보가 수정되었습니다.`);
        } else {
          packData.push(newPack);
          addHistory('팩 추가', title, `${title} 팩이 추가되었습니다.`);
        }

        renderList(packData);
        showPackDetail(newPack);
        alert('저장되었습니다.');
        renderDevHome();
      }

      function deletePack(idx) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        const title = packData[idx].title;
        packData.splice(idx, 1);
        addHistory('팩 삭제', title, `${title} 팩이 삭제되었습니다.`);
        renderList(packData);
        if (packData.length > 0) showPackDetail(packData[0]);
        else document.getElementById('packDetailContent').innerHTML = '';
        alert('삭제되었습니다.');
        renderDevHome();
      }

      function exportJson() {
        const data = {
          packs: packData,
          history: changeHistory,
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mappack.json';
        a.click();
        URL.revokeObjectURL(url);
      }

      function renderGitHubConfig() {
        const isTokenFixed = !!GH_TOKEN;
        document.getElementById('devContent').innerHTML = `
          <h3>GitHub 연동 설정</h3>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <label class="dev-label">Repository Owner (고정)</label>
            <input class="dev-input" value="${githubConfig.owner}" readonly style="background:#222; color:#888;">
            <label class="dev-label">Repository Name (고정)</label>
            <input class="dev-input" value="${githubConfig.repo}" readonly style="background:#222; color:#888;">
            <label class="dev-label">File Path (고정)</label>
            <input class="dev-input" value="${githubConfig.path}" readonly style="background:#222; color:#888;">
            <label class="dev-label">Personal Access Token ${isTokenFixed ? '(고정됨)' : ''}</label>
            <input id="gh-token" class="dev-input" type="password" value="${githubConfig.token}" ${isTokenFixed ? 'readonly style="background:#222; color:#888;"' : 'placeholder="ghp_..."'}>
            ${!isTokenFixed ? '<button class="dev-btn dev-btn-save" onclick="saveGitHubConfig()">토큰 저장</button>' : ''}
            <button class="dev-btn" onclick="renderDevHome()">뒤로가기</button>
          </div>
        `;
      }

      function saveGitHubConfig() {
        if (!GH_TOKEN) {
          githubConfig.token = document.getElementById('gh-token').value.trim();
          localStorage.setItem('gh_token', githubConfig.token);
          alert('토큰이 저장되었습니다.');
        }
        renderDevHome();
      }

      async function saveToGitHub() {
        if (!githubConfig.token || !githubConfig.owner || !githubConfig.repo) {
          if (confirm('GitHub 설정이 필요합니다. 설정 화면으로 이동할까요?'))
            renderGitHubConfig();
          return;
        }
        const content = JSON.stringify(
          { packs: packData, history: changeHistory },
          null,
          2,
        );
        const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`;
        try {
          let sha = null;
          const getRes = await fetch(url, {
            headers: {
              Authorization: `Bearer ${githubConfig.token}`,
              Accept: 'application/vnd.github.v3+json',
            },
          });
          if (getRes.ok) {
            const json = await getRes.json();
            sha = json.sha;
          }
          const putRes = await fetch(url, {
            method: 'PUT',
            headers: {
              Authorization: `Bearer ${githubConfig.token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: `Update ${githubConfig.path} via Web`,
              content: btoa(unescape(encodeURIComponent(content))),
              sha: sha,
            }),
          });
          if (putRes.ok) alert('GitHub에 성공적으로 저장되었습니다!');
          else {
            const err = await putRes.json();
            alert(`저장 실패: ${err.message}`);
          }
        } catch (e) {
          alert(`오류 발생: ${e.message}`);
        }
      }

      function toggleMenu() {
        const header = document.querySelector('.header-container');
        header.classList.toggle('open');
      }
    </script>
  </body>
</html>
