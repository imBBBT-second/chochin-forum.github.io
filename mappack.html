<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="user-scalable=no, initial-scale=1.0" />
<title>초친 포럼 (맵 팩)</title>

<style>
/* --- 기본 설정 --- */
html, body {
  height: 100%;
  margin: 0;
  background: #323232;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}
* { box-sizing: border-box; }

/* 폰트 설정 */
@font-face { font-family: Paperlogy1; src: url('font - paperlogy/Paperlogy-1.ttf'); }
@font-face { font-family: Paperlogy2; src: url('font - paperlogy/Paperlogy-2.ttf'); }
@font-face { font-family: Paperlogy3; src: url('font - paperlogy/Paperlogy-3.ttf'); }
@font-face { font-family: Paperlogy4; src: url('font - paperlogy/Paperlogy-4.ttf'); }
@font-face { font-family: Paperlogy5; src: url('font - paperlogy/Paperlogy-5.ttf'); }
@font-face { font-family: Paperlogy6; src: url('font - paperlogy/Paperlogy-6.ttf'); }
@font-face { font-family: Paperlogy7; src: url('font - paperlogy/Paperlogy-7.ttf'); }
@font-face { font-family: Paperlogy8; src: url('font - paperlogy/Paperlogy-8.ttf'); }
@font-face { font-family: Paperlogy9; src: url('font - paperlogy/Paperlogy-9.ttf'); }

a { color: inherit; text-decoration: none; }

/* --- 헤더 영역 --- */
.header-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5vw;
  padding: 2vh 0;
  flex-wrap: wrap;
}
.header-btn-wrapper {
  width: min(400px, 90vw);
  display: flex;
  justify-content: center;
}
.header-btn {
  background-color: #323232;
  color: white;
  font-size: clamp(1.5rem, 4vw, 3rem);
  cursor: pointer;
  padding: 1.5vh 0;
  border: none;
  border-radius: 10px;
  width: 100%;
  transition: background-color 0.25s ease, color 0.25s ease;
  font-family: Paperlogy5;
}
.header-btn:hover, .header-btn.active {
  background-color: #fff;
  color: #323232;
}
.divider {
  border: 2px solid white;
  width: 100%;
  height: 0;
  margin: 6px 0;
}

/* --- 메인 컨테이너 --- */
.main-container {
  display: flex;
  gap: 20px;
  padding: 20px;
  align-items: stretch;
  min-height: 800px;
}
  
.container,
.detail-panel {
  background: #404040;
  border-radius: 10px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.container { flex: 1; min-width: 0; }
.detail-panel { flex: 2; background: #505050; overflow-y: auto; min-width: 0; }
.detail-panel.clears-panel { flex: 1; background: #404040; }

.history-panel {
  width: calc(100% - 40px);
  margin: 0 auto 40px auto;
  background: #3a3a3a;
  border-radius: 10px;
  padding: 20px;
  min-height: 200px;
}

@media (max-width: 1400px) {
  .main-container { flex-direction: column; }
  .container, .detail-panel, .detail-panel.clears-panel { width: 100%; margin-bottom: 20px; height: 600px; flex: none; }
}

/* --- 리스트 아이템 스타일 --- */
.item {
  display: flex;
  align-items: center;
  padding: 15px;
  gap: 15px;
  border-bottom: 1px solid #777;
  cursor: pointer;
  transition: 0.2s;
}
.item:hover, .item.active { background-color: #ffffff; }
.item:hover *, .item.active * { color: #000000 !important; }

.pack-tier {
  font-family: Paperlogy9;
  font-size: 1.8rem;
  min-width: 60px;
  text-align: center;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5); 
}
.title { font-family: Paperlogy7; font-size: 1.4rem; color: #fff; }
.creator { font-family: Paperlogy4; font-size: 0.9rem; color: #d0d0d0; }

/* --- 상세 정보 패널 --- */
.detail-header { text-align: center; margin-bottom: 20px; }
.pack-title { font-family: Paperlogy9; font-size: 3rem; color: #fff; margin-bottom: 5px; }
.pack-subtitle { font-family: Paperlogy4; font-size: 1.1rem; color: #aaa; }

.pack-content-box {
  background: #444;
  border-radius: 10px;
  padding: 20px;
  margin-top: 20px;
}
.content-header {
  font-family: Paperlogy6;
  font-size: 1.5rem;
  color: #fff;
  margin-bottom: 15px;
  border-bottom: 2px solid #666;
  padding-bottom: 10px;
}
.level-item {
  display: flex;
  align-items: center;
  padding: 10px;
  background: #3a3a3a;
  border-radius: 8px;
  margin-bottom: 8px;
  transition: 0.2s;
  cursor: pointer;
}
.level-item:hover { background: #666; transform: translateX(5px); }
.level-idx {
  font-family: Paperlogy7;
  font-size: 1.2rem;
  color: #aaa;
  width: 40px;
  text-align: center;
}
.level-info { flex: 1; }
.level-name { font-family: Paperlogy6; font-size: 1.1rem; color: #fff; }
.level-author { font-family: Paperlogy4; font-size: 0.85rem; color: #ccc; }

.clear-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 10px;
  border-bottom: 1px solid #555;
  color: #fff;
  font-family: Paperlogy5;
}

#detailHeader { text-align: center; margin-bottom: 60px; }
#headerTitle { font-family: Paperlogy7; font-size: 120px; color: #fff; margin: 20px 0; }
#detailSubtitle { color: #aaa; font-family: Paperlogy3; font-size: 24px; }

/* 개발자 패널 */
.dev-panel {
  position: fixed; top: 0; right: -480px; width: 480px; height: 100%;
  background: #2f2f2f; box-shadow: -4px 0 16px rgba(0,0,0,0.5);
  transition: 0.3s; z-index: 9999; display: flex; flex-direction: column;
}
.dev-panel.open { right: 0; }
.dev-content { padding: 20px; overflow-y: auto; flex: 1; }
.dev-input { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: none; font-family: Paperlogy5; }
.dev-label { color: #fff; margin-bottom: 5px; display: block; font-family: Paperlogy4; }

/* 개별 레벨이 클리어되었을 때 */
.level-item.cleared {
  background-color: #2e4a2e !important;
  color: #4f9 !important;
}

/* 맵 팩 전체를 클리어했을 때 (카드 테두리와 배경 강조) */
.mappack-card.all-cleared {
  background-color: #1e3a1e !important;
  border: 3px solid #4f9 !important;
  box-shadow: 0 0 15px rgba(79, 255, 153, 0.3);
}

/* 체크 표시 아이콘 */
.check-mark {
  color: #4f9;
  margin-left: 5px;
  display: none;
}
.level-item.cleared .check-mark {
  display: inline;
}

.mode-btn {
  background: transparent; border: 1.5px solid #fff; color: #fff; padding: 6px 16px; border-radius: 999px;
  font-family: Paperlogy7; font-size: clamp(1.2rem, 3vw, 2rem); font-weight: 500; cursor: pointer; transition: background 0.2s, color 0.2s;
}
.mode-btn:hover { background: #fff; color: #000; }
.mode-btn.active { background: #fff; color: #000; font-weight: 600; cursor: default; }

</style>
</head>

<body>

<div class="header-container">
  <a href="../index.html" class="header-btn-wrapper"><button class="header-btn">홈</button></a>
  <a href="level/classic.html" class="header-btn-wrapper"><button class="header-btn">레벨</button></a>
  <div class="header-btn-wrapper"><button class="header-btn active">맵 팩</button></div>
  <div class="header-btn-wrapper"><button class="header-btn">하디스트</button></div>
  <div style="text-align: right; padding-right: 20px;">
    <button onclick="login()" class="mode-btn" style="font-size: 0.9rem; padding: 5px 15px;">계정 선택</button>
  </div>
</div>

<div class="divider"></div>

<div id="detailHeader">
  <div id="headerTitle">Map Packs</div>
  <div id="detailSubtitle">다양한 테마와 난이도로 묶인 맵 팩에 도전하세요!</div>
</div>

<div class="main-container">
  <div class="container">
    <input id="search" placeholder="팩 검색..." style="width:100%; padding:10px; border-radius:8px; border:none;">
    <div id="packList" style="overflow-y:auto; flex:1;"></div>
  </div>

  <div class="detail-panel">
    <div id="packDetailContent">
      <div style="text-align:center; margin-top:50px; color:#888; font-family:Paperlogy5;">데이터를 불러오는 중...</div>
    </div>
  </div>

  <div class="detail-panel clears-panel">
    <div style="font-family:Paperlogy9; font-size:2.5rem; text-align:center; color:white; margin-bottom:20px;">All Clears</div>
    <div id="packClears"></div>
  </div>
</div>

<div class="history-panel">
  <div style="font-family:Paperlogy9; font-size:2rem; text-align:center; color:white; margin-bottom:10px;">최근 변경 기록</div>
  <div id="historyBox"></div>
</div>

<div id="devPanel" class="dev-panel">
  <div style="padding:20px; border-bottom:1px solid #555;">
    <h2 style="color:white; font-family:Paperlogy7; margin:0;">관리자 패널</h2>
  </div>
  <div id="devContent" class="dev-content"></div>
  <button class="header-btn" onclick="exportJson()" style="margin:20px;">JSON 저장</button>
</div>

<script>
const DEV_PASSWORD = '6974';
const TIER_COLORS = {
  "Tier 1": "#00ffff", "Tier 2": "#00ff00", "Tier 3": "#ffff00",
  "Tier 4": "#ffaa00", "Tier 5": "#ff0000", "Tier 6": "#ff00ff", "Unrated": "#888888"
};

let packData = [];
let classicLevelData = []; 
let changeHistory = [];

// [수정] level/classic.json 경로에서 데이터를 가져옴
Promise.all([
  fetch('mappack.json').then(r => r.json()).catch(() => ({ packs: [], history: [] })),
  fetch('level/classic.json').then(r => r.json()).catch(() => ({ levels: [] })) // levels 대신 buttons
]).then(([packJson, levelJson]) => {
  packData = packJson.packs || [];
  changeHistory = packJson.history || [];
  classicLevelData = levelJson.levels || []; // 이 부분을 buttons로 변경!
  
  initPage();
}).catch(err => {
  console.error("데이터 로딩 실패:", err);
  document.getElementById('packDetailContent').innerHTML = "데이터 로드 오류";
});

function initPage() {
  renderList(packData);
  renderHistory();
  if(packData.length > 0) showPackDetail(packData[0]);
}

function renderList(data) {
  const list = document.getElementById('packList');
  list.innerHTML = '';
  data.forEach(pack => {
    const div = document.createElement('div');
    div.className = 'item';
    const tierColor = TIER_COLORS[pack.tier] || "#ffffff";
    div.innerHTML = `
      <div class="pack-tier" style="color: ${tierColor}">${pack.tier}</div>
      <div>
        <div class="title">${pack.title}</div>
        <div class="creator">by ${pack.creator}</div>
      </div>
    `;
    div.onclick = () => showPackDetail(pack, div);
    list.appendChild(div);
  });
}

// [핵심] classicLevelData를 검색해서 이동
function goToLevelAuto(levelName, author) {
  // classicLevelData(json의 buttons 배열)에서 찾기
  const target = classicLevelData.find(l => 
    l.title.trim().toLowerCase() === levelName.trim().toLowerCase() &&
    l.creator.trim().toLowerCase() === author.trim().toLowerCase()
  );

  if (target && target.id) {
    window.location.href = `level/classic.html?id=${target.id}`;
  } else {
    // 찾지 못했을 때 디버깅을 위해 콘솔에 데이터를 찍어볼 수 있어
    console.log("검색 중인 레벨:", levelName, author);
    console.log("대상 데이터 리스트:", classicLevelData);
    alert(`'${levelName}' 레벨을 찾을 수 없습니다. (제작자: ${author})`);
  }
}

function showPackDetail(pack, el) {
  document.querySelectorAll('.item.active').forEach(i => i.classList.remove('active'));
  if(el) el.classList.add('active');

  const tierColor = TIER_COLORS[pack.tier] || "#ffffff";
  const content = document.getElementById('packDetailContent');
  
  content.innerHTML = `
    <div class="detail-header">
      <div class="pack-title">${pack.title}</div>
      <div class="pack-subtitle">${pack.description}</div>
      <div style="margin-top:10px;">
        <span style="background:#333; padding:5px 12px; border-radius:15px; border: 1px solid ${tierColor}; color: ${tierColor}; font-weight:bold;">${pack.tier}</span>
        <span style="background:#444; padding:5px 12px; border-radius:15px; margin-left:5px; color:#ddd;">Levels: ${pack.levels.length}</span>
      </div>
    </div>

    <div class="pack-content-box">
      <div class="content-header">수록곡 리스트</div>
      ${pack.levels.map((lvl, idx) => `
        <div class="level-item" onclick="goToLevelAuto('${lvl.name}', '${lvl.author}')">
          <div class="level-idx">${idx + 1}</div>
          <div class="level-info">
            <div class="level-name">${lvl.name}</div>
            <div class="level-author">by ${lvl.author}</div>
          </div>
          <div style="color:#888; font-size:0.8rem;">Click to View →</div>
        </div>
      `).join('')}
    </div>
  `;

  const clearBox = document.getElementById('packClears');
  clearBox.innerHTML = '';
  if(pack.clears && pack.clears.length > 0) {
    pack.clears.forEach(c => {
      const row = document.createElement('div');
      row.className = 'clear-row';
      row.innerHTML = `<span class="clear-user">${c.player}</span><span class="clear-date">${c.date}</span>`;
      clearBox.appendChild(row);
    });
  } else {
    clearBox.innerHTML = '<div style="text-align:center; color:#777; margin-top:20px;">클리어 유저가 없습니다.</div>';
  }
}

document.getElementById('search').addEventListener('input', (e) => {
  const val = e.target.value.toLowerCase();
  const filtered = packData.filter(p => p.title.toLowerCase().includes(val));
  renderList(filtered);
});

/* --- 관리자 패널 --- */
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'e') {
    if (prompt('비밀번호') === DEV_PASSWORD) {
      document.getElementById('devPanel').classList.add('open');
      renderDevHome();
    }
  }
});

function renderDevHome() {
  const box = document.getElementById('devContent');
  box.innerHTML = `
    <button class="header-btn" onclick="renderAddPack()">팩 추가</button>
    <button class="header-btn" onclick="renderAddClear()">클리어 기록 추가</button>
    <button class="header-btn" onclick="document.getElementById('devPanel').classList.remove('open')" style="margin-top:20px;">닫기</button>
  `;
}

function renderAddPack() {
  const box = document.getElementById('devContent');
  box.innerHTML = `
    <div class="dev-label">팩 제목</div>
    <input id="p-title" class="dev-input">
    <div class="dev-label">티어</div>
    <select id="p-tier" class="dev-input">
      ${Object.keys(TIER_COLORS).map(k => `<option value="${k}">${k}</option>`).join('')}
    </select>
    <div class="dev-label">설명</div>
    <input id="p-desc" class="dev-input">
    <div class="dev-label">레벨 목록 (JSON)</div>
    <textarea id="p-levels" class="dev-input" style="height:150px; background:#444; color:#fff;" placeholder='[{"name":"이름", "author":"제작자"}]'></textarea>
    <button class="header-btn" onclick="submitPack()">저장</button>
  `;
}

function submitPack() {
  try {
    const newPack = {
      id: "pack" + Date.now(),
      title: document.getElementById('p-title').value,
      tier: document.getElementById('p-tier').value,
      creator: "Admin",
      description: document.getElementById('p-desc').value,
      levels: JSON.parse(document.getElementById('p-levels').value),
      clears: []
    };
    packData.push(newPack);
    addHistory("팩 추가", newPack.title);
    initPage();
    renderDevHome();
  } catch(e) { alert("JSON 오류"); }
}

function renderAddClear() {
  const box = document.getElementById('devContent');
  box.innerHTML = `
    <div class="dev-label">팩 선택</div>
    <select id="c-pack" class="dev-input">
      ${packData.map((p, i) => `<option value="${i}">${p.title}</option>`).join('')}
    </select>
    <div class="dev-label">플레이어</div>
    <input id="c-player" class="dev-input">
    <button class="header-btn" onclick="submitClear()">추가</button>
  `;
}

function submitClear() {
  const idx = document.getElementById('c-pack').value;
  const player = document.getElementById('c-player').value;
  if(!player) return;
  packData[idx].clears.push({ player, date: new Date().toISOString().split('T')[0] });
  showPackDetail(packData[idx]);
  renderDevHome();
}

function addHistory(type, msg) {
  changeHistory.unshift({ time: new Date().toISOString().split('T')[0], type, detail: msg });
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById('historyBox');
  box.innerHTML = changeHistory.slice(0, 10).map(h => `
    <div style="color:#ccc; font-family:Paperlogy3; margin-bottom:5px;">
      <span style="color:#66ccff">[${h.time}]</span> <b>${h.type}</b>: ${h.detail}
    </div>
  `).join('');
}

function exportJson() {
  const data = { packs: packData, history: changeHistory };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mappack.json';
  a.click();
}

// classic.html에서 저장한 계정 정보를 가져옴
let currentUser = localStorage.getItem('currentUser') || null;

function checkIfLevelCleared(levelTitle) {
  if (!currentUser) return false;
  
  // demonData는 classic.json에서 가져온 레벨 배열
  const levelData = demonData.find(l => l.title === levelTitle);
  if (!levelData) return false;

  const name = currentUser.toLowerCase();

  // 1. 클리어 명단에 100% 기록이 있는지 확인
  const isCleared = levelData.clears && levelData.clears.some(c => 
    c.player.toLowerCase() === name && Number(c.percent) === 100
  );
  
  // 2. 검증자(Verifier)인지 확인
  const isVerifier = levelData.verifier && levelData.verifier.toLowerCase() === name;

  return isCleared || isVerifier;
}

function renderMapPacks() {
  const container = document.getElementById('mappackContainer');
  container.innerHTML = '';

  mapPacks.forEach(pack => {
    let clearedCount = 0;
    
    // 팩 내부 레벨들의 HTML 생성
    const levelsHTML = pack.levels.map(title => {
      const cleared = checkIfLevelCleared(title);
      if (cleared) clearedCount++;
      
      return `
        <div class="level-item ${cleared ? 'cleared' : ''}">
          <span>${title}</span>
          <span class="check-mark">✅</span>
        </div>
      `;
    }).join('');

    // 모든 레벨을 다 깼는지 확인
    const isAllCleared = clearedCount === pack.levels.length && pack.levels.length > 0;

    const packCard = document.createElement('div');
    packCard.className = `mappack-card ${isAllCleared ? 'all-cleared' : ''}`;
    packCard.innerHTML = `
      <div class="mappack-title">${pack.title}</div>
      <div class="progress">Progress: ${clearedCount} / ${pack.levels.length}</div>
      <div class="level-list">${levelsHTML}</div>
    `;
    container.appendChild(packCard);
  });
}

function login() {
  const name = prompt("닉네임을 입력해주세요.");
  if (!name) return;

  currentUser = name;
  alert(`${name}님, 환영합니다!`);
  
  // 리스트를 다시 그려서 초록색 적용
  generateList(filteredData);
}
</script>
</body>
</html>
